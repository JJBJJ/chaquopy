name: æž„å»º curl-cffi (Python 3.8 arm64-v8a)

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  æž„å»ºå®‰å“åŒ…:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ› ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ è®¾ç½® Python 3.8 çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.8.18'

    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "å¼€å§‹å®‰è£…ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          patch \
          patchelf \
          wget \
          unzip \
          pkg-config \
          libssl-dev \
          autoconf \
          automake \
          libtool
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ðŸ¤– è®¾ç½® Android SDK
      run: |
        echo "æ­£åœ¨è®¾ç½® Android SDK..."
        mkdir -p android-sdk/cmdline-tools/latest
        cd android-sdk/cmdline-tools/latest
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        cd ../../..
        echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
        echo "âœ… Android SDK è®¾ç½®å®Œæˆ"

    - name: â¬‡ï¸ ä¸‹è½½ Python 3.8.20-1 ç›®æ ‡æ–‡ä»¶
      run: |
        echo "æ­£åœ¨ä¸‹è½½ Python 3.8.20-1 ç›®æ ‡æ–‡ä»¶..."
        cd server/pypi
        # ä½¿ç”¨å›¾ç‰‡ä¸­å¯ç”¨çš„æœ€æ–°ç‰ˆæœ¬ 3.8.20-1
        ../../target/download-target.sh maven/com/chaquo/python/target/3.8.20-1
        echo "âœ… Python 3.8.20-1 ç›®æ ‡æ–‡ä»¶ä¸‹è½½å®Œæˆ"

    - name: ðŸ“š å®‰è£… Python æž„å»ºä¾èµ–
      run: |
        echo "æ­£åœ¨å®‰è£… Python æž„å»ºä¾èµ–..."
        cd server/pypi
        pip install -r requirements.txt
        pip install cffi setuptools wheel
        echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"

    - name: ðŸ“ åˆ›å»º curl-cffi æž„å»ºé…æ–¹
      run: |
        echo "åˆ›å»º curl-cffi æž„å»ºé…æ–¹..."
        cd server/pypi/packages
        
        # åˆ›å»º curl-cffi é…æ–¹ç›®å½•
        mkdir -p curl-cffi
        
        # åˆ›å»º meta.yaml é…ç½®æ–‡ä»¶
        cat > curl-cffi/meta.yaml << 'EOF'
        package:
          name: curl-cffi
          version: 0.5.0

        source:
          url: https://files.pythonhosted.org/packages/source/c/curl-cffi/curl-cffi-0.5.0.tar.gz
          sha256: 73e4ff0bfdeb97d6b4a8c04d5c037b970d3d8b0ad29faba3810c4c0e0d2d4f5c

        build:
          number: 0
          script: python -m pip install . --no-deps --no-build-isolation

        requirements:
          build:
            - python
            - pip
            - setuptools
            - wheel
            - cffi
          host:
            - python
            - cffi
            - pycparser
          run:
            - python
            - cffi

        test:
          imports:
            - curl_cffi
        EOF
        
        # åˆ›å»ºæž„å»ºè„šæœ¬
        cat > curl-cffi/build.sh << 'EOF'
        #!/bin/bash
        echo "å¼€å§‹æž„å»º curl-cffi..."
        
        # è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
        export CFLAGS="$CFLAGS -I$PREFIX/include"
        export LDFLAGS="$LDFLAGS -L$PREFIX/lib"
        
        # å®‰è£…æž„å»ºä¾èµ–
        $PYTHON -m pip install cffi pycparser
        
        # æž„å»ºåŒ…
        $PYTHON -m pip install . --no-deps --no-build-isolation
        
        echo "âœ… curl-cffi æž„å»ºå®Œæˆ"
        EOF
        
        chmod +x curl-cffi/build.sh
        echo "âœ… curl-cffi æž„å»ºé…æ–¹åˆ›å»ºå®Œæˆ"

    - name: ðŸ”¨ æž„å»º arm64-v8a Wheel åŒ…
      run: |
        echo "å¼€å§‹æž„å»º arm64-v8a æž¶æž„çš„ curl-cffi..."
        cd server/pypi
        ./build-wheel.py --python 3.8 --abi arm64-v8a packages/curl-cffi/
        echo "âœ… arm64-v8a æž„å»ºå®Œæˆ"

    - name: ðŸ”¨ æž„å»º armeabi-v7a Wheel åŒ…
      run: |
        echo "å¼€å§‹æž„å»º armeabi-v7a æž¶æž„çš„ curl-cffi..."
        cd server/pypi
        ./build-wheel.py --python 3.8 --abi armeabi-v7a packages/curl-cffi/
        echo "âœ… armeabi-v7a æž„å»ºå®Œæˆ"

    - name: ðŸ“Š æ£€æŸ¥æž„å»ºäº§ç‰©
      run: |
        echo "æž„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
        ls -la server/pypi/dist/
        echo "ç”Ÿæˆçš„ .whl æ–‡ä»¶ï¼š"
        find server/pypi/dist -name "*.whl" -exec echo "ðŸ“¦ {}" \;

    - name: â¬†ï¸ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: curl-cffi-python3.8-wheels
        path: server/pypi/dist/
        retention-days: 30

    - name: âœ… æž„å»ºå®ŒæˆæŠ¥å‘Š
      run: |
        echo "ðŸŽ‰ æž„å»ºä»»åŠ¡å®Œæˆï¼"
        echo "ðŸ“‹ æž„å»ºè¯¦æƒ…ï¼š"
        echo "   ðŸ Python ç‰ˆæœ¬: 3.8.20-1"
        echo "   ðŸ“± ç›®æ ‡æž¶æž„: arm64-v8a, armeabi-v7a"
        echo "   ðŸ“¦ åŒ…åç§°: curl-cffi"
        echo "   â° å®Œæˆæ—¶é—´: $(date)"
        echo "   ðŸ“ äº§ç‰©ä½ç½®: server/pypi/dist/"
