name: æž„å»º curl-cffi Android åŒ…

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  æž„å»ºå®‰å“åŒ…:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ› ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ è®¾ç½® Python 3.8 çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.8.18'

    - name: ðŸ“¦ å®‰è£…å¿…éœ€ç³»ç»Ÿå·¥å…·
      run: |
        echo "ðŸ”§ å®‰è£…æ–‡æ¡£è¦æ±‚çš„ç³»ç»Ÿå·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y patch patchelf
        echo "âœ… ç³»ç»Ÿå·¥å…·å®‰è£…å®Œæˆ"

    - name: â¬‡ï¸ ä¸‹è½½ Python 3.8.20-1 ç›®æ ‡æ–‡ä»¶
      run: |
        echo "ðŸ“¥ ä¸‹è½½ Android Python 3.8.20-1 ç›®æ ‡æ–‡ä»¶..."
        cd server/pypi
        ../../target/download-target.sh maven/com/chaquo/python/target/3.8.20-1
        echo "âœ… Python ç›®æ ‡æ–‡ä»¶ä¸‹è½½å®Œæˆ"

    - name: ðŸ“š å®‰è£… Python æž„å»ºä¾èµ–
      run: |
        echo "ðŸ“– å®‰è£… Python æž„å»ºä¾èµ–..."
        cd server/pypi
        pip install -r requirements.txt
        echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"

    - name: ðŸ“ åˆ›å»º curl-cffi æž„å»ºé…æ–¹
      run: |
        echo "ðŸ“‹ åˆ›å»º curl-cffi æž„å»ºé…æ–¹..."
        cd server/pypi/packages
        
        # åˆ›å»º curl-cffi é…æ–¹ç›®å½•
        mkdir -p curl-cffi
        
        # åˆ›å»º meta.yaml é…ç½®æ–‡ä»¶
        cat > curl-cffi/meta.yaml << 'EOF'
        package:
          name: curl-cffi
          version: 0.5.0

        source:
          url: https://files.pythonhosted.org/packages/source/c/curl-cffi/curl-cffi-0.5.0.tar.gz
          sha256: 73e4ff0bfdeb97d6b4a8c04d5c037b970d3d8b0ad29faba3810c4c0e0d2d4f5c

        build:
          number: 0
          script: python -m pip install . --no-deps --no-build-isolation

        requirements:
          build:
            - python
            - pip
            - setuptools
            - wheel
            - cffi
          host:
            - python
            - cffi
            - pycparser
          run:
            - python
            - cffi

        test:
          imports:
            - curl_cffi
        EOF
        
        echo "âœ… curl-cffi æž„å»ºé…æ–¹åˆ›å»ºå®Œæˆ"

    - name: ðŸ”¨ æž„å»º arm64-v8a æž¶æž„åŒ…
      run: |
        echo "ðŸ—ï¸ å¼€å§‹æž„å»º arm64-v8a æž¶æž„..."
        cd server/pypi
        ./build-wheel.py --python 3.8 --abi arm64-v8a packages/curl-cffi/
        echo "âœ… arm64-v8a æž„å»ºå®Œæˆ"

    - name: ðŸ”¨ æž„å»º armeabi-v7a æž¶æž„åŒ…
      run: |
        echo "ðŸ—ï¸ å¼€å§‹æž„å»º armeabi-v7a æž¶æž„..."
        cd server/pypi
        ./build-wheel.py --python 3.8 --abi armeabi-v7a packages/curl-cffi/
        echo "âœ… armeabi-v7a æž„å»ºå®Œæˆ"

    - name: ðŸ“Š æ£€æŸ¥æž„å»ºäº§ç‰©
      run: |
        echo "ðŸ“¦ æ£€æŸ¥ç”Ÿæˆçš„åŒ…æ–‡ä»¶..."
        echo "æž„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
        ls -la server/pypi/dist/
        echo "ç”Ÿæˆçš„ .whl æ–‡ä»¶ï¼š"
        find server/pypi/dist -name "*.whl" | while read file; do
          echo "ðŸŽ¯ æ‰¾åˆ°: $file"
        done

    - name: â¬†ï¸ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: curl-cffi-android-wheels
        path: server/pypi/dist/
        retention-days: 30

    - name: âœ… æž„å»ºå®ŒæˆæŠ¥å‘Š
      run: |
        echo "ðŸŽ‰ æž„å»ºä»»åŠ¡å®Œæˆï¼"
        echo "ðŸ“Š æž„å»ºè¯¦æƒ…ï¼š"
        echo "   ðŸ Python ç‰ˆæœ¬: 3.8.20-1"
        echo "   ðŸ“± ç›®æ ‡æž¶æž„: arm64-v8a, armeabi-v7a" 
        echo "   ðŸ“¦ åŒ…åç§°: curl-cffi 0.5.0"
        echo "   â° å®Œæˆæ—¶é—´: $(date)"
        echo "   ðŸ“ äº§ç‰©ä½ç½®: server/pypi/dist/"
        echo ""
        echo "ðŸ” ä¸‹ä¸€æ­¥ï¼šå°†ç”Ÿæˆçš„ .whl æ–‡ä»¶ç”¨äºŽæ‚¨çš„ Android é¡¹ç›®"
